- name: copying kubeconfig from master01 to controller
  hosts: haproxy
  become: yes
  tasks:
    - name: creating $HOME/.kube folder
      become: yes
      file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: copy file admin.conf
      become: yes
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: /home/{{ ansible_user }}/config
        flat: yes
      delegate_to: master01

    - name: copy file admin.conf
      become: yes
      copy:
        src: /home/{{ ansible_user }}/config
        dest: /home/{{ ansible_user }}/.kube/config

    - name: installing git 
      apt:
        name: git
        state: present
      become: yes
      become_method: sudo

    - name: Download helm using get_url 
      become: yes
      get_url:
        url: https://github.com/helm/helm/releases/download/v3.12.2/helm-v3.12.2-linux-amd64.tar.gz.asc
        dest: /usr/local/bin
        mode: 0755

    - name: Downloading kubectl
      become: yes
      get_url:
        url: https://storage.googleapis.com/kubernetes-release/release/{{ RELEASE }}/bin/linux/amd64/kubectl
        dest: '/usr/local/bin/'
        mode: '+x'

    - name: unzip helm
      become: yes
      unarchive:
        src: /usr/local/bin/helm-v3.12.2-linux-amd64.tar.gz.asc
        dest: /usr/local/bin/
        remote_src: yes
    
    - name: Download helmfile using get_url
      become: yes
      get_url:
        url: https://github.com/helmfile/helmfile/releases/download/v0.155.0/helmfile_0.155.0_linux_amd64.tar.gz
        dest: /usr/bin
        mode: 0755

    - name: unzip helmfile
      become: yes
      unarchive:
        src: /usr/bin/helmfile_0.155.0_linux_amd64.tar.gz
        dest: /usr/bin/helmfile_0.155.0_linux_amd64.tar.gz
        remote_src: yes

    - name: installing helmfile plugin 
      shell: helm plugin install https://github.com/databus23/helm-diff

    - name: create ns apis
      shell: kubectl create ns apis

    - name: creating smbcreds
      shell: kubectl create secret generic smbcreds --from-literal=username={{ ansible_user }} --from-literal=password={{ ansible_password }} -n apis

    - name: add csi driver nfs repo
      shell: helm repo add csi-driver-nfs https://raw.githubusercontent.com/kubernetes-csi/csi-driver-nfs/master/charts

    - name: installing csi driver nfs 
      shell: helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --set nfs.server={{ nfs }} --set nfs.path={{ nfs-folder }}/ -n kube-system

    - name: add csi driver smb repo
      shell: helm repo add csi-driver-smb https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts

    - name: installing csi driver smb
      shell: helm install csi-driver-smb csi-driver-smb/csi-driver-smb -n kube-system --version v1.11.0
